// LoadSubsidiaryAccountMasterInteractor - 補助科目マスタ取得Interactor

use std::sync::Arc;

use javelin_domain::repositories::SubsidiaryAccountMasterRepository;

use crate::{
    dtos::{
        request::LoadSubsidiaryAccountMasterRequest,
        response::{LoadSubsidiaryAccountMasterResponse, SubsidiaryAccountMasterItem},
    },
    error::ApplicationResult,
    input_ports::LoadSubsidiaryAccountMasterInputPort,
    output_port::SubsidiaryAccountMasterOutputPort,
};

/// 補助科目マスタ取得Interactor
pub struct LoadSubsidiaryAccountMasterInteractor<R, O>
where
    R: SubsidiaryAccountMasterRepository,
    O: SubsidiaryAccountMasterOutputPort,
{
    repository: Arc<R>,
    output_port: O,
}

impl<R, O> LoadSubsidiaryAccountMasterInteractor<R, O>
where
    R: SubsidiaryAccountMasterRepository,
    O: SubsidiaryAccountMasterOutputPort,
{
    pub fn new(repository: Arc<R>, output_port: O) -> Self {
        Self { repository, output_port }
    }
}

#[allow(async_fn_in_trait)]
impl<R, O> LoadSubsidiaryAccountMasterInputPort for LoadSubsidiaryAccountMasterInteractor<R, O>
where
    R: SubsidiaryAccountMasterRepository,
    O: SubsidiaryAccountMasterOutputPort,
{
    async fn execute(
        &self,
        request: LoadSubsidiaryAccountMasterRequest,
    ) -> ApplicationResult<LoadSubsidiaryAccountMasterResponse> {
        // リポジトリから全件取得
        let accounts = self
            .repository
            .find_all()
            .await
            .map_err(|e| crate::error::ApplicationError::QueryExecutionFailed(e.to_string()))?;

        // フィルタリング
        let mut items: Vec<SubsidiaryAccountMasterItem> = accounts
            .into_iter()
            .filter(|acc| {
                // アクティブフィルタ
                if request.active_only && !acc.is_active() {
                    return false;
                }
                // テキストフィルタ
                if let Some(ref filter) = request.filter {
                    let filter_lower = filter.to_lowercase();
                    return acc.code().value().to_lowercase().contains(&filter_lower)
                        || acc.name().value().to_lowercase().contains(&filter_lower);
                }
                true
            })
            .map(|acc| SubsidiaryAccountMasterItem {
                code: acc.code().value().to_string(),
                name: acc.name().value().to_string(),
                parent_account_code: acc.parent_account_code().value().to_string(),
                is_active: acc.is_active(),
            })
            .collect();

        // コード順にソート
        items.sort_by(|a, b| a.code.cmp(&b.code));

        let response = LoadSubsidiaryAccountMasterResponse { accounts: items };

        // Output Portに通知
        self.output_port.present_subsidiary_account_master(&response).await;

        Ok(response)
    }
}
